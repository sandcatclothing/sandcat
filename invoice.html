<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Invoice - SANDCAT</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Estilos específicos para la factura (no editable) */
    .invoice-wrap{
      max-width: 980px; margin: 30px auto; padding: 20px;
      background: #000; color: #00ff66; border: 1px solid #0f4; border-radius: 10px;
      box-shadow: 0 12px 36px rgba(0,255,102,.06);
      user-select: text;               /* permitir seleccionar para copiar */
      -webkit-user-select: text;
    }
    .invoice-header{
      display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 14px;
    }
    .invoice-title{
      font-size: 1.4rem; letter-spacing: .5px;
    }
    .invoice-meta{
      font-size: .95rem; opacity:.9; text-align:right;
    }
    .invoice-grid{
      display:grid; grid-template-columns: 1fr 1fr; gap: 18px; margin: 16px 0 8px;
    }
    .invoice-box{
      border:1px solid #0f4; border-radius:8px; padding:12px; background:#000;
    }
    .invoice-box h4{
      margin:0 0 8px 0; color:#6aff9e; font-weight:400; font-size: 1rem;
    }
    table.invoice-items{
      width:100%; border-collapse:collapse; margin-top:10px; border:1px solid #0f4;
    }
    table.invoice-items th, table.invoice-items td{
      text-align:left; padding:10px; border-bottom:1px dashed #0f4; vertical-align:top;
    }
    table.invoice-items th{ color:#6aff9e; font-weight:400; background:#001a0c; }
    .totals{
      margin-top:10px; display:flex; justify-content:flex-end;
    }
    .totals table{
      border-collapse:collapse; min-width:320px; border:1px solid #0f4;
    }
    .totals td{
      padding:10px; border-bottom:1px dashed #0f4;
    }
    .totals tr:last-child td{
      border-bottom:none; font-weight:700; color:#6aff9e; background:#001a0c;
    }
    .invoice-actions{
      margin-top:18px; display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }
    .muted{ opacity:.85; }
    /* Desactivar cualquier edición del contenido por seguridad extra */
    [contenteditable="true"] { outline: none; }
  </style>
</head>
<body>
  <!-- Intro opcional (respetará la regla de solo-primera-vez) -->
  <div id="hack-screen"><div id="hack-text"></div></div>

  <!-- Barra superior -->
  <div class="white-bar" aria-hidden="true">
    <img src="assets/logo2.png" class="logo-left" alt="SANDCAT"/>
    <img src="assets/logo_text.png" class="logo-center" alt="SANDCAT"/>
    <div class="top-icons">
      <div class="hamburger" onclick="window.location.href='index.html'">☰</div>
    </div>
  </div>

  <!-- Contenido factura -->
  <div id="console-menu">
    <div class="console-line" style="cursor:default;">&gt; invoice</div>
  </div>

  <div class="invoice-wrap" id="invoice-root" aria-live="polite" aria-busy="true">
    <!-- Se rellena por JS -->
    <div class="console-line">Loading invoice…</div>
  </div>

  <div class="newsletter sticky-newsletter" aria-hidden="true">
    <p>Subscribe to our newsletter:</p>
    <input type="email" placeholder="youremail@example.com" disabled />
  </div>

  <div id="page-loader"><img src="assets/sandcatloading.png" alt="Loading..."></div>

  <script src="script.js"></script>
  <script>
    // Render no editable de la factura desde localStorage.last_order
    (function renderInvoice(){
      // no permitir edición del documento
      document.designMode = 'off';

      // respetar comportamiento de intro y loader premium
      startHackAnimation();
      ensurePageLoaderMounted();
      hidePageLoader();

      const container = document.getElementById('invoice-root');
      try{
        const raw = localStorage.getItem('last_order');
        if(!raw){
          container.innerHTML = `
            <div class="invoice-header">
              <div class="invoice-title">Invoice</div>
              <div class="invoice-meta">No order found</div>
            </div>
            <div class="invoice-box">
              You don't have a recent order in this device. Please place an order first.
            </div>
            <div class="invoice-actions">
              <button onclick="window.location.href='shop.html'">Go to Shop</button>
              <button onclick="window.location.href='index.html'">Home</button>
            </div>
          `;
          container.setAttribute('aria-busy','false');
          return;
        }

        const order = JSON.parse(raw || '{}');
        // Sanidad mínima
        const orderId   = order.orderId || 'N/A';
        const createdAt = order.createdAt ? new Date(order.createdAt).toLocaleString() : new Date().toLocaleString();
        const method    = (order.method || '').toUpperCase();
        const status    = order.status || '';
        const total     = Number(order.total || 0).toFixed(2);
        const currency  = order.currency || 'EUR';
        const cust      = order.customer || {};
        const items     = Array.isArray(order.items) ? order.items : [];

        // Construir filas de items
        const rows = items.map((it, idx) => `
          <tr>
            <td>${String(idx+1).padStart(2,'0')}</td>
            <td>${escapeHtml(it.name || '')}</td>
            <td>${escapeHtml(it.size || 'N/A')}</td>
            <td>€${Number(it.price || 0).toFixed(2)}</td>
            <td>${Number(it.qty || 1)}</td>
            <td>€${Number((it.price || 0) * (it.qty || 1)).toFixed(2)}</td>
          </tr>
        `).join('');

        container.innerHTML = `
          <div class="invoice-header">
            <div class="invoice-title">SANDCAT — Invoice</div>
            <div class="invoice-meta">
              <div><b>Order:</b> ${escapeHtml(orderId)}</div>
              <div><b>Date:</b> ${escapeHtml(createdAt)}</div>
              <div><b>Method:</b> ${escapeHtml(method)} <span class="muted">(${escapeHtml(status)})</span></div>
            </div>
          </div>

          <div class="invoice-grid">
            <div class="invoice-box">
              <h4>Billing to</h4>
              <div>${escapeHtml(cust.name || '')}</div>
              ${cust.email ? `<div class="muted">${escapeHtml(cust.email)}</div>` : ''}
              <div class="muted">${escapeHtml(cust.address || '')}</div>
              ${cust.zip ? `<div class="muted">ZIP: ${escapeHtml(cust.zip)}</div>` : ''}
            </div>

            <div class="invoice-box">
              <h4>Seller</h4>
              <div>Sandcat</div>
              <div class="muted">sandcat.es</div>
              <div class="muted">support@sandcat.es</div>
            </div>
          </div>

          <table class="invoice-items" aria-label="Items">
            <thead>
              <tr>
                <th>#</th>
                <th>Item</th>
                <th>Size</th>
                <th>Price</th>
                <th>Qty</th>
                <th>Subtotal</th>
              </tr>
            </thead>
            <tbody>
              ${rows || `<tr><td colspan="6">No items</td></tr>`}
            </tbody>
          </table>

          <div class="totals">
            <table>
              <tr><td>Subtotal</td><td>€${Number(total).toFixed(2)} ${escapeHtml(currency)}</td></tr>
              <tr><td>Shipping</td><td>€0.00</td></tr>
              <tr><td>Total</td><td>€${Number(total).toFixed(2)} ${escapeHtml(currency)}</td></tr>
            </table>
          </div>

          <div class="invoice-actions">
            <button onclick="window.print()">Print</button>
            <button onclick="window.location.href='index.html'">Back to Home</button>
          </div>

          <div class="muted" style="margin-top:8px; font-size:.9rem;">
            This invoice is a read-only view generated on your device from the last confirmed order.
            No customer data is saved or transmitted from this page.
          </div>
        `;

        container.setAttribute('aria-busy','false');

      } catch(err){
        container.innerHTML = `
          <div class="invoice-header">
            <div class="invoice-title">Invoice</div>
            <div class="invoice-meta">Error</div>
          </div>
          <div class="invoice-box">Unable to render invoice: ${escapeHtml(String(err))}</div>
          <div class="invoice-actions">
            <button onclick="window.location.href='index.html'">Back to Home</button>
          </div>
        `;
        container.setAttribute('aria-busy','false');
      }
    })();

    function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
  </script>
</body>
</html>

